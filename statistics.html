<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>إحصائيات شجرة أسرة السياط</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap');

        body {
            font-family: 'Noto Naskh Arabic', sans-serif;
            direction: rtl;
        }
        .container {
            width: 30%;
            margin: 0 auto;
        }
        
        @media only screen and (max-width: 600px) {
            .container {
                width: 90%;
            }
        }

        h2 {
            text-align: center;
            direction: ltr;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        .top-names li {
            background: #f4f4f4;
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }
        .top-children li {
            background: #f4f4f4;
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .name {
            flex: 1;
            text-align: right;
        }
        .count {
            flex: 0.5;
            text-align: left;
        }
        .total-members {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUIB9GPZGJDUkqUajtCHeA-2TNb0kDNZc",
            authDomain: "family-tree-7e938.firebaseapp.com",
            projectId: "family-tree-7e938",
            storageBucket: "family-tree-7e938.appspot.com",
            messagingSenderId: "488428637219",
            appId: "1:488428637219:web:fb497a31a38fa5c6bff596"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>
<body>
    <div class="container">
        <div class="total-members" id="total-members"></div>
        <h2>أكثر الأسماء تكراراً</h2>
        <ul id="top-names" class="top-names"></ul>
        <h2>ًأكثر الأفراد أبناء</h2>
        <ul id="top-children" class="top-children"></ul>
    </div>

    <script>
        async function fetchStatistics() {
            try {
                const doc = await db.collection('statistics').doc('familyTreeStatistics').get();
                if (!doc.exists) {
                    console.error('No such document!');
                    return null;
                }
                console.log('Document data:', doc.data());
                return doc.data();
            } catch (error) {
                console.error('Error getting document:', error);
            }
        }

        function displayStatistics(statistics) {
            if (!statistics) {
                document.getElementById('total-members').innerText = "لا توجد بيانات إحصائية";
                return;
            }

            const { topNames, topChildren, totalMembers } = statistics;

            document.getElementById('total-members').innerText = `إجمالي عدد أفراد الأسرة: ${totalMembers}`;

            const groupedNames = {};
            topNames.forEach(([name, count]) => {
                if (!groupedNames[count]) {
                    groupedNames[count] = [];
                }
                groupedNames[count].push(name);
            });

            const sortedNames = Object.entries(groupedNames)
                .map(([count, names]) => [names.join('، '), parseInt(count)])
                .sort((a, b) => b[1] - a[1]);

            const topNamesList = document.getElementById('top-names');
            sortedNames.forEach(([names, count]) => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="name">${names}</div><div class="count">${count}</div>`;
                topNamesList.appendChild(li);
            });

            const groupedChildren = {};
            topChildren.forEach(({ fullName, children }) => {
                if (!groupedChildren[children]) {
                    groupedChildren[children] = [];
                }
                groupedChildren[children].push(fullName);
            });

            const sortedChildren = Object.entries(groupedChildren)
                .map(([children, names]) => [names, parseInt(children)])
                .sort((a, b) => b[1] - a[1]);

            const topChildrenList = document.getElementById('top-children');
            let resultCount = 0;
            for (const [names, children] of sortedChildren) {
                if (resultCount >= 10) break;

                const li = document.createElement('li');
                li.innerHTML = `<div class="count">عدد الأبناء: ${children}</div>`;
                names.forEach(name => {
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'name';
                    nameDiv.innerText = `- ${name}.`;
                    li.appendChild(nameDiv);
                });
                topChildrenList.appendChild(li);
                resultCount++;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const statistics = await fetchStatistics();
            displayStatistics(statistics);
        });
    </script>
</body>
</html>
